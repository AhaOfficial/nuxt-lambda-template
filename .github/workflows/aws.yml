name: Deploy master branch

# ë§ˆìŠ¤í„° ë¸ŒëŸ°ì¹˜ì— ë³€ë™ì´ ìƒê¸°ë©´ ìë™ ë°°í¬ë¥¼ ì‹œì‘í•©ë‹ˆë‹¤.
on:
  push:
    branches:
      - master

jobs:
  deploy:
    name: AWS Lambda Deploy

    # ìµœì‹  ìš°ë¶„íˆ¬ë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤.
    runs-on: ubuntu-latest
    strategy:
      matrix:
        # ë¹Œë“œ ì‹œ ë…¸ë“œ ë²„ì „ì„ 12ë²ˆëŒ€ë¡œ ì‚¬ìš©í•©ë‹ˆë‹¤.
        node-version: [12.x]

    # ìˆœì„œëŒ€ë¡œ ì‘ì—…ì„ ì‹¤í–‰ì‹œí‚µë‹ˆë‹¤.
    steps:
      - name: ğŸ“¦  ê¹ƒí—ˆë¸Œ ë ˆí¬ í´ë¡ 
        uses: actions/checkout@v2

      - name: ğŸ“¦  Node.js ì„¤ì¹˜ ${{ matrix.node-version }}
        uses: actions/setup-node@v1
        with:
          node-version: ${{ matrix.node-version }}

      - name: ğŸ“¦  ì¢…ì† íŒ¨í‚¤ì§€ ì„¤ì¹˜
        run: |
          npm install -g typescript ts-node
          npm i -g serverless
          npm ci

      - name: ğŸš€  AWS ë°°í¬ ì‹œì‘
        run: |
          serverless config credentials --provider aws --key ${{ secrets.AWS_ACCESS_KEY_ID }} --secret ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          npm run deploy:lambda

      - name: ğŸ”®  CDN ê°±ì‹  (AWS Invalidation)
        uses: awact/cloudfront-action@master
          env:
            # ë¬´íš¨í™”ì‹œí‚¬ ê²½ë¡œ
            SOURCE_PATH: {{ secrets.CLOUDFRONT_INVALIDATION_PATH }}

            # S3 ë¦¬ì „
            AWS_REGION: ${{ secrets.CLOUDFRONT_S3_REGION }}

            # í´ë¼ìš°ë“œ í”„ë¡ íŠ¸ ID
            DISTRIBUTION_ID: ${{ secrets.DISTRIBUTION_ID }}
            AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
            AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
